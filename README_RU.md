# Описание программы "Prepare After Updater"

Программа предназначена для автоматизации настройки пользовательских окружений после обновления системы или развертывания новых машин. Она выполняет загрузку конфигураций, установку программ и выполнение настроек для выбранных пользователей.

**Документация/Documentation:**

[`Read to English Language`](README.md)
[`Сборка проекта`](docs/RU/README_compile.md)
[`Механизм работы программы`](docs/RU/README_Mechanisms.md)

---

## **1. Основные функции и алгоритм работы**

### **1.1. Инициализация и обработка аргументов**
- **Парсинг флагов командной строки**:
  - `--version` — вывод версии программы 
  - `--help` — вывод справки по использованию
  - `--home` — указание пути к домашним директориям пользователей (по умолчанию `/home`)
  - `--exclude` — список префиксов для исключения пользователей (например, `a_,adminsec`)
  - `--user` — обработка конкретного пользователя (по имени)
  - `--config` — путь к конфигурационному файлу (по умолчанию `/etc/prepare-after-updater/config.json`)
  - `--download` — имя скачиваемого файла конфигурации (по умолчанию `web_cfg.json`)
  - `--log` — путь к файлу логов (по умолчанию `/var/log/prepare-after-updater.log`)
  - `--autoconfig` — генерация шаблона конфигурации и выход

- **Проверка прав**:
  - Программа требует запуска от `root` (`os.Geteuid() != 0` → ошибка).

---

### **1.2. Загрузка и обработка конфигурации**
#### **1.2.1. Конфигурация приложения (`AppConfig`)**
Структура:
```json
{
  "resource_url": "URL или file:// путь к конфигурации",
  "home_dir": "/home",
  "log_path": "/var/log/prepare-after-updater.log",
  "exclude_prefixes": ["a_", "adminsec"]
}
```
- Если конфиг не указан, используются значения по умолчанию.
- Флаги командной строки переопределяют параметры из конфига.

#### **1.2.2. Конфигурация программ (`ProgramConfig`)**
Структура:
```json
{
  "programs": [
    {
      "name": "Имя программы",
      "config_paths": [".config/app"],
      "check_command": "команда для проверки установки",
      "action": "install | execute",
      "packages": {"apt": "пакет1 пакет2", "yum": "пакет1 пакет2"},
      "command": "команда для выполнения",
      "post_action": ["команда1", "команда2"]
    }
  ]
}
```
- Загружается из `web_cfg.json` (локально или по URL).
- Поддерживается загрузка:
  - По HTTP (`http://example.com/config.json`)
  - Из локального файла (`file:///path/to/config.json`)

---

### **1.3. Выбор пользователя для обработки**
1. Если указан `--user`, обрабатывается только его домашняя директория.
2. Если пользователь не указан:
   - Сканируется `home_dir` (по умолчанию `/home`).
   - Исключаются папки с префиксами из `exclude_prefixes`.
   - Выводится интерактивное меню выбора пользователя.

---

### **1.4. Обработка программ (основной workflow)**
Для каждой программы из конфига:
1. **Проверка конфигурации**:
   - Ищет файлы в `config_paths` (например, `~/.config/app`).
   - Если файлы есть → программа считается настроенной.

2. **Определение действия**:
   - Если `action` не указан:
     - Если конфиг найден → `action = "execute"`.
     - Если конфига нет → `action = "install"`.

3. **Выполнение действия**:
   - **Установка (`install`)**:
     - Проверяет, установлена ли программа (`check_command`).
     - Если нет → устанавливает через пакетный менеджер (`apt`, `apt-get`, `yum`, `dnf`).
   - **Выполнение (`execute`)**:
     - Запускает команду из `command`.
   - **Пост-действия (`post_action`)**:
     - Выполняет дополнительные команды после установки/настройки.

4. **Параллельная обработка**:
   - Программы обрабатываются конкурентно (горутины + `sync.WaitGroup`).

---

### **1.5. Дополнительные функции**
- **Обновление пакетной базы**:
  - Автоматически определяет менеджер пакетов (`apt`, `apt-get`, `yum`, `dnf`).
  - Выполняет `apt update` / `yum check-update`.
- **Логирование**:
  - Пишет в файл (`/var/log/prepare-after-updater.log`) и `stdout`.
  - Формат: `[дата] [время] сообщение`.
- **Генерация шаблона конфига**:
  - `--autoconfig output.json` → создает JSON-шаблон для ручного редактирования.

---

## **2. Примеры использования**
### **2.1. Установка программ для пользователя `user1`**
```bash
sudo prepare-after-updater --user user1 --download https://example.com/config.json
```
1. Скачивает `config.json` по URL.
2. Применяет настройки только для `/home/user1`.

### **2.2. Интерактивный выбор пользователя**
```bash
sudo prepare-after-updater --config /etc/custom-config.json
```
1. Загружает конфиг из `/etc/custom-config.json`.
2. Выводит список пользователей (исключая `a_*`, `adminsec*`).
3. Обрабатывает выбранного пользователя.

### **2.3. Генерация шаблона**
```bash
prepare-after-updater --autoconfig myconfig.json
```
Создает `myconfig.json` с примером настройки программ.

---

## **3. Обработка ошибок и особенности**
- **Ошибки загрузки конфигурации**:
  - Если URL недоступен → программа завершается с ошибкой.
  - Если локальный файл не найден → используется конфиг по умолчанию.
- **Проверка зависимостей**:
  - Если не найден пакетный менеджер → только ручная установка.
- **Права доступа**:
  - Требуются права `root` для установки пакетов и доступа к `/home`.
- **Временные файлы**:
  - Скачанный `web_cfg.json` удаляется после обработки.

---

## **4. Логика в деталях (псевдокод)**
```plaintext
1. Парсинг аргументов
2. Если --version → вывод версии и выход
3. Если --help → вывод справки и выход
4. Если --autoconfig → генерация шаблона и выход
5. Инициализация логгера
6. Проверка прав (только root)
7. Загрузка конфигурации (флаги > конфиг > значения по умолчанию)
8. Обновление пакетной базы (если доступен менеджер пакетов)
9. Выбор пользователя:
   - Если --user → обработать только его
   - Иначе → интерактивный выбор
10. Для выбранного пользователя:
    - Скачать конфигурацию программ (если указан URL)
    - Для каждой программы:
      - Определить действие (install/execute)
      - Установить или выполнить команду
      - Запустить post-actions
11. Закрытие лог-файла и завершение
```

---
### **Итог**
Программа автоматизирует:
- Установку ПО через пакетные менеджеры.
- Настройку пользовательских окружений.
- Выполнение пост-установочных команд.

Гибкость обеспечивается:
- Поддержкой JSON-конфигураций.
- Возможностью загрузки конфигов по URL.
- Параллельным выполнением задач.
- Расширенным логированием.