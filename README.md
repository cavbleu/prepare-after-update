# Программа управления установкой программ для пользователей Linux

## Описание программы

Программа предназначена для автоматической проверки и установки программного обеспечения на Linux-системах после переустановки системы и переразмеченным томом `/home`. Она выполняет следующие функции:

1. Сканирует домашние директории пользователей
   - Рекурсивный поиск домашних директорий
   - Фильтрация по префиксам (исключение системных папок)
   - Поддержка пользовательских путей
2. Проверяет наличие конфигурационных файлов указанных программ
3. Устанавливает недостающее ПО согласно конфигурации
   - Автоматическое определение менеджера пакетов (APT/APT-GET/YUM/DNF)
   - Обновление базы перед установкой
   - Проверка установленных версий
   - Установка/обновление пакетов
   - Автоопределение нужных действий
   - Выполнение пост-установочных скриптов
4. Работа с конфигурациями
   - Многоуровневая система настроек конфигураций: `Флаги командной строки (наивысший приоритет), Локальный config.json (средний приоритет), Встроенные значения по умолчанию (низший приоритет)`
   - Поддержка удаленных и локальных конфигураций
   - Автогенерация шаблонов конфигураций
   - Валидация JSON-структуры
5. Ведет подробный лог всех операций
   - Запись вывода всех выполняемых команд
   - Подробные сообщения об ошибках
   - Возможность настройки пути к лог-файлу
6. Безопасность:
   - Проверка прав root
   - Очистка временных файлов
7. Гибкость:
   - Поддержка разных дистрибутивов Linux

## Требования

- ОС: Linux (AltLinux, Ubuntu, Debian, RHEL, Fedora и производные)
- Права `root` для установки пакетов
- Доступ в интернет для загрузки конфигурационного файла
- Установленные базовые утилиты: `curl, apt-get/apt/yum/dnf` (в зависимости от дистрибутива)

## Сборка

### 1. Инициализируйте модули:
```bash
go mod init tidy
```
### 2. Скомпилируйте программу:
```bash
go build -o prepare-after-update prepare-after-update.go
chmod +x prepare-after-update
```

### 3. Скопируйте в нужную директорию:
```bash
sudo cp prepare-after-update /usr/local/bin/
```

### 4. Создайте ссылку в директории sbin:
```bash
sudo ln -s /usr/local/bin/prepare-after-update /sbin
```

### 5. Создайте файл конфигурации (средний приоритет) для работы программы любым редактором в директории программы с именем `config.json`:
Пример:
```json
{
  "resource_url": "http://mysite.com/config.json",
  "home_dir": "/home",
  "log_path": "/var/log/prepare-after-update.log",
  "exclude_prefixes": ["a_", "admin", "temp_"]
}
```


### Использование флагов программы (наивысший приоритет):
```bash
sudo prepare-after-update [ФЛАГИ]
```

#### Флаги программы

| Флаг         | Тип    | Обязательный | Описание                                                                 | Значение по умолчанию                          | Пример использования                     |
|--------------|--------|--------------|--------------------------------------------------------------------------|-----------------------------------------------|------------------------------------------|
| `--help`     | bool   | Нет          | Показать справку по использованию программы                              | -                                             | `--help`                                 |
| `--version`  | bool   | Нет          | Показать версию программы                                               | -                                             | `--version`                              |
| `--config` | string | Нет          | Путь к конфигурационнуму пути программы                                   | `/etc/prepare-after-updater/config.json` | `--config config.json` |
| `--download` | string | Нет          | URL для скачивания JSON-конфигурации                                    | `https://example.com/path/to/programs_config.json` | `--download http://mysite.com/config.json` |
| `--home`     | string | Нет          | Путь к домашним директориям пользователей                               | `/home`                                       | `--home /mnt/home`                       |
| `--log`   | string | Нет          | Полный путь к файлу логов                                               | `./tmp_updates/run.log`                       | `--log /var/log/installer.log`        |
| `--exclude`  | string | Нет          | Префиксы директорий для исключения (через запятую без пробелов)          | `a_,adminsec`                                 | `--exclude a_,test,temp`                 |
| `--autoconfig`  | string | Нет          | Генерация шаблона web-конфигурации         | `a_,admin`                                 | `--autoconfig my_config.json`                 |
| `--user`  | string | Нет          | Указание конкретного пользователя         | `user`                                 | `--user username`                 |

### Особенности использования флагов:

1. **Порядок флагов** не имеет значения
2. Можно комбинировать несколько флагов:
   ```bash
   sudo prepare-after-update --home /mnt/home --exclude a_,test --logout /var/log/installer.log
   ```
3. Для флагов `--help` и `--version` другие флаги игнорируются
4. В значениях флагов не используйте кавычки, даже если есть пробелы:

Правильно: `--exclude a_,test,temp`

Неправильно: `--exclude "a_,test,temp"`

### Примеры использования:

```bash
# Базовая установка с параметрами по умолчанию
sudo prepare-after-update

# С указанием альтернативного источника конфигурации
sudo prepare-after-update --download https://my.domain.com/config.json

# С указанием альтернативного локального источника конфигурации
sudo prepare-after-update --download file:///absolute/path/to/web_cfg.json

# С изменением домашней директории и файла логов
sudo prepare-after-update --home /mnt/home --logout /var/log/installer.log

# С дополнительными исключениями директорий
sudo prepare-after-update --exclude "a_,test,temp" 
```

## Формат JSON-конфигурации:\

Поля в структуре скачиваемого json-файла:

- Action - определяет тип операции ("install" или "execute")

- Command - команда для выполнения (если action = "execute")

- PostAction - команды выполняемые после установки пакетов

Логика обработки:

- Если action не указан, программа автоматически определяет:

- Установка, если конфигурации нет

- Выполнение команды, если конфигурация есть

- При выполнении команд выводится их вывод в лог

- Пост-действия выполняются в любом случае

```json
{
  "programs": [
    {
      "name": "Node.js",
      "config_paths": [".nvm", ".node_repl_history"],
      "check_command": "node --version",
      "action": "install", // или "execute"
      "packages": {
        "apt": "nodejs npm",
        "yum": "nodejs npm",
        "dnf": "nodejs npm"
      },
      "command": "npm install -g yarn", // команда для выполнения
      "post_action": [
        "systemctl restart node-service",
        "logrotate -f /etc/logrotate.d/node"
      ]
    },
    {//Установка пакетов (явное указание):
      "name": "Docker",
      "action": "install",
      "packages": {
        "apt": "docker-ce docker-compose"
      }
    },
    {//Выполнение команды:
      "name": "Update config",
      "action": "execute",
      "command": "cp /tmp/new_config.ini ~/.config/app/config.ini",
      "config_paths": [".config/app"]
    },
    {//Автоматический выбор (не указывать action):
      "name": "Nginx",
      "config_paths": ["nginx.conf"],
      "command": "nginx -t && systemctl reload nginx"
    }
  ]
}
```

Поля конфигурации:
* name - отображаемое имя программы
* config_paths - список относительных путей к конфигурационным файлам/директориям в домашней папке пользователя
* check_command - команда для проверки наличия программы в системе
* action - указание действия (install, execute)
* packages - список пакетов для установки (apt, apt-get, yum, dnf)
* command - команда для выполнения (если action = "execute")
* post_action - команда выполнения после установки

### Пример реальной конфигурации в JSON-файле:

```json
{
  "programs": [
    {
      "name": "Node.js",
      "config_paths": [".nvm", ".node_repl_history"],
      "check_command": "node --version",
      "action": "install", // или "execute"
      "packages": {
        "apt": "nodejs npm",
        "yum": "nodejs npm",
        "dnf": "nodejs npm"
      },
      "command": "npm install -g yarn", // команда для выполнения
      "post_action": [
        "systemctl restart node-service",
        "logrotate -f /etc/logrotate.d/node"
      ]
    },
    {
      "name": "Docker",
      "action": "install",
      "packages": {
        "apt": "docker-ce docker-compose"
      }
    },
    {
      "name": "Update config",
      "action": "execute",
      "command": "cp /tmp/new_config.ini ~/.config/app/config.ini",
      "config_paths": [".config/app"]
    },
    {
      "name": "Nginx",
      "config_paths": ["nginx.conf"],
      "command": "nginx -t && systemctl reload nginx"
    }
  ]
}
```

### Доступность JSON-ресурса
Конфигурационный JSON-файл должен быть доступен по HTTP/HTTPS. Рекомендации:

1. Размещение:

* На веб-сервере организации

* В облачном хранилище (S3, GitHub Gist и т.д.)

* На внутреннем файловом сервере

2. Требования к доступности:

* URL должен быть доступен с машин, где запускается программа

* Сервер должен отдавать файл с правильными HTTP-заголовками

* Рекомендуется использовать HTTPS для безопасности

4. Частота обновления:

* Программа скачивает конфигурацию при каждом запуске

* Для изменения списка устанавливаемых программ достаточно обновить JSON-файл

5. Безопасность:

* Рекомендуется подписывать конфигурацию или проверять хеш

* Можно ограничить доступ по IP

## Логирование
Программа ведет подробный лог всех операций:

По умолчанию: /var/log/prepare-after-updater.log

Можно изменить флагом --log

Лог дублируется в stdout

Формат логов:

```log
[Дата Время] Сообщение
```

## Алгоритм работы
* Проверка прав root

* Загрузка конфигурации (--download)

* Сканирование домашних директорий (--home)

* Фильтрация по исключениям (--exclude)

* Выбор пользователя (интерактивно)

* Для каждой программы в конфигурации:

1. Проверка наличия конфигурационных файлов

2. Проверка установленной программы

3. Установка (если требуется)

4. Выполнение пост команд

5. Запись результатов в лог



